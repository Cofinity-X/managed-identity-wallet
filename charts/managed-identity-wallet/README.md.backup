<a name="readme-top"></a>

# Tractus-X Managed Identity Wallet

![Version: 1.0.1](https://img.shields.io/badge/Version-1.0.1-informational?style=flat-square) ![Type: application](https://img.shields.io/badge/Type-application-informational?style=flat-square) ![AppVersion: 0.0.1](https://img.shields.io/badge/AppVersion-0.0.1-informational?style=flat-square)

Managed Identity Wallet is supposed to supply a secure data source and data sink for Digital Identity Documents (DID),
in order to enable Self-Sovereign Identity founding on those DIDs.
And at the same it shall support an uninterrupted tracking and tracing and documenting the usage of those DIDs, e.g.
within logistical supply chains.

**Homepage:** <https://github.com/eclipse-tractusx/managed-identity-wallet>

## Table of Contents

<!-- TABLE OF CONTENTS -->
<ol>
    <li><a href="#general-information">General Information</a>
        <ul>
            <li><a href="#get-repo-info">Get Repository Info</a></li>
            <li><a href="#install-chart">Install Chart</a></li>
            <li><a href="#uninstall-chart">Uninstall Chart</a></li>
            <li><a href="#upgrading-chart">Upgrading Chart</a></li>
            <li><a href="#requirements">Requirements</a></li>
        </ul>
    </li>
    <li><a href="#parameters">Parameters</a>
        <ul>
            <li><a href="#miw-common-parameters">MIW Common parameters</a></li>
            <li><a href="#managed-identity-wallet-common-parameters">Managed Identity Wallet Common Parameters</a></li>
            <li><a href="#managed-identity-wallet-primary-parameters">Managed Identity Wallet Primary Parameters</a></li>
            <li><a href="#keycloak-parameters">Keycloak Parameters</a></li>
            <li><a href="#postgresql-parameters">Postgresql Parameters</a></li>
        </ul>
    </li>
    <li><a href="#configuration">Configuration</a></li>
</ol>

## General Information

### Get Repository Info

    helm repo add tractusx-dev https://eclipse-tractusx.github.io/charts/dev
    helm repo update

    
    helm repo add tractusx-stable https://eclipse-tractusx.github.io/charts/stable
    helm repo update

<p align="right">(<a href="#readme-top">back to top</a>)</p>

### Install Chart

    helm install [RELEASE_NAME] tractusx-dev/managed-identity-wallet

    helm install [RELEASE_NAME] tractusx-stable/managed-identity-wallet

The command deploys miw on the Kubernetes cluster in the default configuration.

See configuration below.

See [helm install](https://helm.sh/docs/helm/helm_install/) for command documentation.

<p align="right">(<a href="#readme-top">back to top</a>)</p>

### Uninstall Chart

    helm uninstall [RELEASE_NAME]

This removes all the Kubernetes components associated with the chart and deletes the release.

See [helm uninstall](https://helm.sh/docs/helm/helm_uninstall/) for command documentation.

<p align="right">(<a href="#readme-top">back to top</a>)</p>

### Upgrading Chart

    helm upgrade [RELEASE_NAME] [CHART]

See [helm upgrade](https://helm.sh/docs/helm/helm_upgrade/) for command documentation.

<p align="right">(<a href="#readme-top">back to top</a>)</p>

### Requirements

| Repository                         | Name       | Version |
|------------------------------------|------------|---------|
| https://charts.bitnami.com/bitnami | common     | 2.x.x   |
| https://charts.bitnami.com/bitnami | keycloak   | 15.1.6  |
| https://charts.bitnami.com/bitnami | postgresql | 11.9.13 |

<p align="right">(<a href="#readme-top">back to top</a>)</p>

## Parameters

### MIW Common parameters

| Name                         | Description                                                                                  | Value                              |
|------------------------------|----------------------------------------------------------------------------------------------|------------------------------------|
| `replicaCount`               | The amount of replicas to run                                                                | `1`                                |
| `nameOverride`               | String to partially override common.names.fullname template (will maintain the release name) | `""`                               |
| `fullnameOverride`           | String to fully override common.names.fullname template                                      | `""`                               |
| `image.repository`           | MIW image repository                                                                         | `tractusx/managed-identity-wallet` |
| `image.pullPolicy`           | MIW image pull policy                                                                        | `Always`                           |
| `image.tag`                  | MIW image tag (empty one will use "appVersion" value from chart definition)                  | `""`                               |
| `secrets`                    | Parameters for the application (will be stored as secrets - so, for passwords, ...)          | `{}`                               |
| `envs`                       | Parameters for the application (will be provided as environment variables)                   | `{}`                               |
| `serviceAccount.create`      | Enable creation of ServiceAccount                                                            | `true`                             |
| `serviceAccount.annotations` | Annotations to add to the ServiceAccount                                                     | `{}`                               |
| `serviceAccount.name`        | The name of the ServiceAccount to use.                                                       | `""`                               |

### Managed Identity Wallet Common Parameters

| Name                                       | Description                                                                                                                       | Value       |
|--------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------|-------------|
| `service.type`                             | Kubernetes Service type                                                                                                           | `ClusterIP` |
| `service.port`                             | Kubernetes Service port                                                                                                           | `8080`      |
| `ingress.enabled`                          | Enable ingress controller resource                                                                                                | `false`     |
| `ingress.annotations`                      | Ingress annotations                                                                                                               | `{}`        |
| `ingress.hosts`                            | Ingress accepted hostnames                                                                                                        | `[]`        |
| `ingress.tls`                              | Ingress TLS configuration                                                                                                         | `[]`        |
| `podSecurityContext`                       | Pod Security Context                                                                                                              | `{}`        |
| `jobSecurityContext.runAsUser`             | User ID used to run the job                                                                                                       | `1001`      |
| `jobSecurityContext.runAsGroup`            | Group ID used to run the job                                                                                                      | `0`         |
| `jobSecurityContext.runAsNonRoot`          | Run the job as a non-root user                                                                                                    | `true`      |
| `securityContext.privileged`               | Enable privileged container                                                                                                       | `false`     |
| `securityContext.allowPrivilegeEscalation` | Allow privilege escalation                                                                                                        | `false`     |
| `securityContext.runAsUser`                | User ID used to run the container                                                                                                 | `1001`      |
| `securityContext.runAsGroup`               | Group ID used to run the container                                                                                                | `0`         |
| `securityContext.runAsNonRoot`             | Run the container as a non-root user                                                                                              | `true`      |
| `resources.requests.cpu`                   | CPU resource requests                                                                                                             | `250m`      |
| `resources.requests.memory`                | Memory resource requests                                                                                                          | `500Mi`     |
| `resources.limits.cpu`                     | CPU resource limits                                                                                                               | `2`         |
| `resources.limits.memory`                  | Memory resource limits                                                                                                            | `1Gi`       |
| `nodeSelector`                             | [node selector](https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/#nodeselector) to constrain pods to nodes | `{}`        |
| `tolerations`                              | Tolerations for pod assignment                                                                                                    | `[]`        |
| `affinity`                                 | Affinity for pod assignment                                                                                                       | `{}`        |
| `podAnnotations`                           | Pod annotations                                                                                                                   | `{}`        |

### Managed Identity Wallet Primary Parameters

| Name                                     | Description                                                                                                                                   | Value                                              |
|------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------|
| `miw.host`                               | Host name                                                                                                                                     | `{{ .Release.Name }}-managed-identity-wallet:8080` |
| `miw.environment`                        | Runtime environment. Should be ether local, dev, int or prod                                                                                  | `dev`                                              |
| `miw.jobs.createDatabaseIfNotExists`     | Enable to create the database if it does not exist                                                                                            | `true`                                             |
| `miw.ssi.enforceHttpsInDidWebResolution` | Enable to use HTTPS in DID Web Resolution                                                                                                     | `false`                                            |
| `miw.ssi.vcExpiryDate`                   | Verifiable Credential expiry date. Format 'dd-MM-yyyy'. If empty it is set to 31-12-<current year>                                            | `""`                                               |
| `miw.authorityWallet.bpn`                | Authority Wallet BPN                                                                                                                          | `BPNL000000000000`                                 |
| `miw.logging.level`                      | Log level. Should be ether ERROR, WARN, INFO, DEBUG, or TRACE.                                                                                | `INFO`                                             |
| `miw.database.useSSL`                    | Set to true to enable SSL connection to the database                                                                                          | `false`                                            |
| `miw.database.port`                      | Database port                                                                                                                                 | `5432`                                             |
| `miw.database.host`                      | Database host                                                                                                                                 | `{{ .Release.Name }}-postgresql`                   |
| `miw.database.user`                      | Database user                                                                                                                                 | `miw`                                              |
| `miw.database.name`                      | Database name                                                                                                                                 | `miw_app`                                          |
| `miw.database.secret`                    | Existing secret name for the database password                                                                                                | `{{ .Release.Name }}-postgresql`                   |
| `miw.database.secretPasswordKey`         | Existing secret key for the database password                                                                                                 | `password`                                         |
| `miw.database.encryptionKey.value`       | Database encryption key for confidential data.  Ignored if `secret` is set. If empty a secret with 32 random alphanumeric chars is generated. | `""`                                               |
| `miw.database.encryptionKey.secret`      | Existing secret for database encryption key                                                                                                   | `""`                                               |
| `miw.database.encryptionKey.secretKey`   | Existing secret key for database encryption key                                                                                               | `""`                                               |
| `miw.keycloak.realm`                     | Keycloak realm                                                                                                                                | `miw_test`                                         |
| `miw.keycloak.clientId`                  | Keycloak client id                                                                                                                            | `miw_private_client`                               |
| `miw.keycloak.url`                       | Keycloak URL                                                                                                                                  | `http://{{ .Release.Name }}-keycloak`              |

### Keycloak Parameters

For more information on how to configure the Keycloak chart
see https://github.com/bitnami/charts/tree/main/bitnami/keycloak

| Name                                                  | Description                                          | Value                            |
|-------------------------------------------------------|------------------------------------------------------|----------------------------------|
| `keycloak.enabled`                                    | Enable to deploy Keycloak                            | `true`                           |
| `keycloak.jobs.createDatabaseIfNotExists`             | Enable to create keycloak database if not exists     | `true`                           |
| `keycloak.extraEnvVars[0].name`                       | KEYCLOAK_HOSTNAME                                    | `KEYCLOAK_HOSTNAME`              |
| `keycloak.extraEnvVars[0].value`                      | {{ .Release.Name }}-keycloak                         | `{{ .Release.Name }}-keycloak`   |
| `keycloak.postgresql.enabled`                         | Enable to deploy PostgreSQL                          | `false`                          |
| `keycloak.externalDatabase.host`                      | Database host                                        | `{{ .Release.Name }}-postgresql` |
| `keycloak.externalDatabase.port`                      | Database port                                        | `5432`                           |
| `keycloak.externalDatabase.user`                      | Database user                                        | `miw`                            |
| `keycloak.externalDatabase.database`                  | Database name                                        | `miw_keycloak`                   |
| `keycloak.externalDatabase.existingSecret`            | Existing secret name for the database password       | `{{ .Release.Name }}-postgresql` |
| `keycloak.externalDatabase.existingSecretPasswordKey` | Existing secret key for the database password        | `password`                       |
| `keycloak.auth.adminUser`                             | Keycloak admin user                                  | `admin`                          |
| `keycloak.auth.adminPassword`                         | Keycloak admin password                              | `""`                             |
| `keycloak.keycloakConfigCli.enabled`                  | Enable to create the miw playground realm            | `true`                           |
| `keycloak.keycloakConfigCli.existingConfigmap`        | Existing configmap name for the realm configuration  | `keycloak-realm-config`          |
| `keycloak.keycloakConfigCli.backoffLimit`             | Number of retries before considering a Job as failed | `2`                              |

### Postgresql Parameters

For more information on how to configure the PostgreSQL chart
see https://github.com/bitnami/charts/tree/main/bitnami/postgresql

| Name                                              | Description                                                                         | Value         |
|---------------------------------------------------|-------------------------------------------------------------------------------------|---------------|
| `postgresql.enabled`                              | Enable to deploy Postgresql                                                         | `true`        |
| `postgresql.auth.enablePostgresUser`              | Enable to create the postgresql admin user                                          | `false`       |
| `postgresql.auth.username`                        | Postgresql user to create                                                           | `miw`         |
| `postgresql.auth.password`                        | Postgresql password to set (if empty one is generated)                              | `""`          |
| `postgresql.backup.enabled`                       | Enable to create a backup cronjob                                                   | `false`       |
| `postgresql.backup.conjob.schedule`               | Backup schedule                                                                     | `* */6 * * *` |
| `postgresql.backup.conjob.storage.existingClaim`  | Name of an existing PVC to use                                                      | `""`          |
| `postgresql.backup.conjob.storage.resourcePolicy` | Set resource policy to "keep" to avoid removing PVCs during a helm delete operation | `keep`        |
| `postgresql.backup.conjob.storage.size`           | PVC Storage Request for the backup data volume                                      | `8Gi`         |

## Deployment

By default, the chart deploys the MIW with a standalone PostgreSQL database and Keycloak.

```mermaid
erDiagram
    ManagedIdentityWallet }o--|| Keycloak: "authentication"
    ManagedIdentityWallet }o--|| PostgreSQL: "persistence"
```

<p align="right">(<a href="#readme-top">back to top</a>)</p>

## Configuration

When deploying the MIW in a production environment please read the following sections carefully.

> **Important Disclaimer**
>
> **The default configuration is intended for development and testing purposes only. It is not secure and should not be
used in production.**
>

<p align="right">(<a href="#readme-top">back to top</a>)</p>

### Secret Management

The following two secrets are required to deploy the MIW in a production environment:

- Database Password
- Database Encryption Key

#### Database Password Secret

TBD

#### Database Encryption Key Secret

TBD

<p align="right">(<a href="#readme-top">back to top</a>)</p>

### Security Considerations

Besides the database password and encryption key, the following security considerations should be taken into account
when deploying the MIW in a production environment:

1. Per default `did:web` are not resolved using HTTPS. This setting is not secure and must be enabled.
2. Set the Managed Identity Wallets environment configuration to `production`.
3. Deploy the _Database Encryption Key Secret_ separately, and don't use the auto generated one.
4. Enable TLS for the database connection.

<p align="right">(<a href="#readme-top">back to top</a>)</p>

### Additional Recommendations

1. Disable deployment the PostgreSQL and Keycloak and don't use the deployments from this chart in production.
2. Find a reasonable Verifiable Credential expiry date. The default is always until the end of the year.
3. The Authority Wallet defaults to `BPNL000000000000`. While it is not unsecure to use the same Authority Wallet ID as
   other data spaces, it is recommended to use a unique ID.
4. Disable database create job and create the database using other methods before deploying the MIW. The MIW database
   user should not be able to do that.

<p align="right">(<a href="#readme-top">back to top</a>)</p>